<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GeoApp</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    h1 { font-size: 1.5em; }
    button { padding: 10px 20px; font-size: 1em; }
    input[type="text"] { padding: 8px; font-size: 1em; margin-bottom: 10px; width: calc(100% - 20px); box-sizing: border-box; }
    pre { background: #f4f4f4; padding: 10px; white-space: pre-wrap; word-wrap: break-word; }
    /* Added style for version info */
    #version-info { font-size: 0.8em; color: #666; text-align: center; margin-top: 25px; padding-top: 15px; border-top: 1px solid #eee; }
    .section { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px dashed #ccc; }
    .section:last-of-type { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
  </style>
</head>
<body>
  <h1 id="app-name">GeoApp</h1>

  <div class="section">
    <h2>Geolocation to Address</h2>
    <p>Tap the button to get your address.</p>
    <button id="locateBtn">Get Address</button>
    <pre id="result"></pre>
  </div>

  <div class="section">
    <h2>Search Rightmove by Postcode</h2>
    <input type="text" id="postcodeInput" placeholder="Enter UK Postcode (e.g., SW1A 1AA)">
    <button id="searchRightmoveBtn">Get Rightmove Link</button>
    <pre id="postcodeResult"></pre>
  </div>

  <!-- Added element for version info -->
  <p id="version-info"></p>

  <script>
    // --- START: Version Information ---
    // IMPORTANT: Manually update this value when you push new changes to GitHub.
    // You can use a date, a version number, or a combination.
    // Example: "v1.0.1 - 2024-03-15 14:30 UTC" or "V5"
    const appDisplayVersion = "V7"; // <-- MANUALLY EDIT THIS LINE (or as requested)
    document.getElementById('version-info').textContent = appDisplayVersion;
    // --- END: Version Information ---

    // Generate an app name based on the User-Agent
    function getAppName() {
      const ua = navigator.userAgent;
      let device = 'Web';
      if (/iPhone/.test(ua)) device = 'iPhone';
      else if (/iPad/.test(ua)) device = 'iPad';
      else if (/Android/.test(ua)) device = 'Android';
      else if (/Windows/.test(ua)) device = 'Windows PC';
      else if (/Mac/.test(ua)) device = 'Mac';
      let browser = 'Browser';
      if (/Safari/.test(ua) && !/Chrome/.test(ua)) browser = 'Safari';
      else if (/Chrome/.test(ua)) browser = 'Chrome';
      else if (/Firefox/.test(ua)) browser = 'Firefox';
      else if (/OPR|Opera/.test(ua)) browser = 'Opera';
      return `${device} ${browser} GeoApp`;
    }
    document.getElementById('app-name').textContent = getAppName();

    const resultEl = document.getElementById('result');
    document.getElementById('locateBtn').addEventListener('click', () => {
      if (!navigator.geolocation) {
        resultEl.textContent = 'Geolocation not supported by your browser.';
        return;
      }
      resultEl.textContent = 'Locating…';
      navigator.geolocation.getCurrentPosition(async (pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        try {
          const resp = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`
          );
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const data = await resp.json();
          const address = data.display_name || JSON.stringify(data.address, null, 2);
          resultEl.textContent = `Coordinates: ${lat}, ${lon}\nAddress: ${address}`;
        } catch (fetchErr) {
          resultEl.textContent = 'Error fetching address: ' + fetchErr.message;
        }
      }, (err) => {
        let message = 'Error getting location: ' + err.message;
        if (err.code === 1) { // PERMISSION_DENIED (err.PERMISSION_DENIED)
          let helpText = "Error: Geolocation permission denied by you or your device settings.\n\n";
          helpText += "To enable location access for this page (" + window.location.hostname + "), please check the following and then tap 'Get Address' again:\n\n";

          helpText += "IPHONE/IPAD (iOS):\n";
          helpText += "1. Go to: iPhone Settings > Privacy & Security > Location Services.\n";
          helpText += "   - Ensure 'Location Services' (at the top) is ON.\n";
          helpText += "   - Scroll down to find your browser ('Safari Websites', 'Chrome', 'Firefox') in the app list and tap it.\n";
          helpText += "   - Select 'Ask Next Time Or When I Share' or 'While Using the App'.\n";
          helpText += "2. If using Safari, ALSO check: iPhone Settings > Safari (scroll down to 'SETTINGS FOR WEBSITES') > Location.\n";
          helpText += "   - Ensure '" + window.location.hostname + "' is not set to 'Deny'. Set to 'Ask' or 'Allow'.\n\n";

          helpText += "ANDROID:\n";
          helpText += "1. In your Browser (e.g., Chrome, Firefox):\n";
          helpText += "   - Tap the menu (usually ⋮ or ☰) > Settings (or 'Settings and privacy').\n";
          helpText += "   - Look for 'Site settings' (or 'Permissions') > 'Location'.\n";
          helpText += "   - Find this site ('" + window.location.hostname + "') in the list (you might need to check 'Blocked').\n";
          helpText += "   - Ensure its permission is set to 'Allow' or 'Ask'.\n";
          helpText += "2. OR, in Android System Settings:\n";
          helpText += "   - Go to: System Settings > Location (ensure 'Use location' or 'Location access' is ON).\n";
          helpText += "   - Then: System Settings > Apps > See all apps > [Your Browser App] > Permissions > Location.\n";
          helpText += "   - Select 'Allow only while using the app' or 'Ask every time'.\n\n";
          message = helpText;
        } else if (err.code === 2) { // POSITION_UNAVAILABLE
          message = 'Error: Location information is unavailable. Please ensure your location services are enabled and try again.';
        } else if (err.code === 3) { // TIMEOUT
          message = 'Error: The request to get user location timed out. Please try again.';
        }
        resultEl.textContent = message;
      }, {
        enableHighAccuracy: true,
        timeout: 10000
      });
    });

    // --- START: Rightmove Postcode Search ---
    const postcodeResultEl = document.getElementById('postcodeResult');
    document.getElementById('searchRightmoveBtn').addEventListener('click', async () => {
      const postcode = document.getElementById('postcodeInput').value.trim();
      if (!postcode) {
        postcodeResultEl.textContent = 'Please enter a postcode.';
        return;
      }

      postcodeResultEl.textContent = 'Searching Rightmove...';

      const formattedPostcode = postcode.toLowerCase().replace(/\s+/g, '-');
      const rightmoveUrl = `https://www.rightmove.co.uk/house-prices/${formattedPostcode}.html`;

      // IMPORTANT: Direct fetch will likely be blocked by CORS.
      // You might need to use a CORS proxy.
      // Example: const proxyUrl = 'https://your-cors-proxy.example.com/';
      // const fetchUrl = proxyUrl + rightmoveUrl;
      const fetchUrl = rightmoveUrl; // Using direct URL, likely to fail from browser

      try {
        // Note: The 'User-Agent' header might be needed if Rightmove blocks default fetch user agents.
        // However, setting it from client-side JS for cross-origin requests is restricted.
        // This is another reason why a server-side proxy is better, as it can set any headers.
        const response = await fetch(fetchUrl);

        if (!response.ok) {
          throw new Error(`HTTP error ${response.status} when fetching Rightmove page. This could be a CORS issue, an invalid postcode, or the page structure changed.`);
        }

        const htmlText = await response.text();

        // Regex to find __PRELOADED_STATE__
        const regex = /__PRELOADED_STATE__\s*=\s*({.*?});?\s*<\/script>/i; // Adjusted regex
        const match = htmlText.match(regex);

        if (match && match[1]) {
          const preloadedStateJSON = match[1];
          const state = JSON.parse(preloadedStateJSON);

          if (state && state.searchLocation && state.searchLocation.locationId) {
            const locId = state.searchLocation.locationId;
            const searchLink = `https://www.rightmove.co.uk/property-for-sale/find.html?locationIdentifier=POSTCODE^${locId}`;
            postcodeResultEl.innerHTML = `Rightmove Search Link: <a href="${searchLink}" target="_blank" rel="noopener noreferrer">${searchLink}</a>`;
          } else {
            postcodeResultEl.textContent = 'Error: Could not find locationId in Rightmove data. The page structure might have changed or the postcode is invalid.';
          }
        } else {
          postcodeResultEl.textContent = 'Error: Could not find __PRELOADED_STATE__ in Rightmove page. The page structure might have changed, the content is not as expected, or the postcode is invalid.';
        }
      } catch (err) {
        postcodeResultEl.textContent = 'Error: ' + err.message + '\n\nNote: Fetching directly from Rightmove in the browser is often blocked by CORS. A CORS proxy or server-side solution might be needed for this feature to work reliably.';
      }
    });
    // --- END: Rightmove Postcode Search ---

  </script>
</body>
</html>
